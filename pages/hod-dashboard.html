<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HOD Dashboard - Course Add/Drop System</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="../index.html" class="logo">
        <div class="logo-icon">
          <img src="../assets/LogoC.JPG" alt="Shaqra University Logo">
        </div>
        <span>Course Add/Drop System</span>
      </a>
      <ul class="nav-links">
        <li><a href="hod-dashboard.html">Dashboard</a></li>
        <li><a href="profile.html">Profile</a></li>
        <li><a href="#" id="logoutBtn">Logout</a></li>
      </ul>
      <button class="hamburger" aria-label="Toggle navigation menu">‚ò∞</button>
    </div>
  </nav>

  <div class="container">
    <div class="dashboard">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="user-name">HOD Name</div>
          <div class="user-role">Head of Department</div>
          <div class="user-dept">Department</div>
        </div>
        <ul class="sidebar-menu">
          <li><a href="hod-dashboard.html" class="active"><span class="icon">üìä</span> Dashboard</a></li>
          <li><a href="#" id="pendingBtn"><span class="icon">‚è≥</span> Pending Requests</a></li>
          <li><a href="#" id="reviewedBtn"><span class="icon">‚úì</span> Reviewed</a></li>
          <li><a href="profile.html"><span class="icon">üë§</span> My Profile</a></li>
          <li><a href="#" id="sidebarLogout"><span class="icon">üö™</span> Logout</a></li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <button class="btn btn-secondary mobile-only" id="toggleSidebar" aria-label="Toggle sidebar" aria-expanded="true">‚ò∞ Menu</button>
          <h1>Head of Department Dashboard</h1>
          <p>Review advisor-approved requests</p>
          <div id="deptBadge" style="display:inline-block;margin-top:0.5rem;padding:0.25rem 0.5rem;border-radius:999px;background: var(--light-bg); color: var(--primary-color); font-weight:600; font-size:0.9rem;">Department: --</div>
        </div>

        <!-- Statistics Cards -->
        <div class="dashboard-stats">
          <div class="stat-card warning">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value" id="awaitingCount">0</div>
            <div class="stat-label">Awaiting Review</div>
          </div>
          <div class="stat-card success">
            <div class="stat-icon">‚úì</div>
            <div class="stat-value" id="approvedCount">0</div>
            <div class="stat-label">Approved</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-icon">‚úó</div>
            <div class="stat-value" id="rejectedCount">0</div>
            <div class="stat-label">Rejected</div>
          </div>
          <div class="stat-card primary">
            <div class="stat-icon">üìã</div>
            <div class="stat-value" id="totalCount">0</div>
            <div class="stat-label">Total Requests</div>
          </div>
        </div>

        <!-- Requests Table -->
        <div class="card">
          <div class="card-header flex-between">
            <div>
              <h2>Department Requests</h2>
              <p>Review advisor-approved student requests</p>
            </div>
            <div class="flex gap-2">
              <select id="filterStatus" class="form-group" style="margin: 0; padding: 0.6rem; border: 2px solid var(--border-color); border-radius: 8px;">
                <option value="all">All Requests</option>
                <option value="awaiting_hod" selected>Awaiting My Review</option>
                <option value="approved">Approved by Me</option>
                <option value="rejected">Rejected by Me</option>
              </select>
              <button class="btn btn-secondary" onclick="loadRequests()">üîÑ Refresh</button>
            </div>
          </div>
          <div class="table-container">
            <table id="requestsTable">
              <thead>
                <tr>
                  <th>Request ID</th>
                  <th>Student</th>
                  <th>Advisor</th>
                  <th>Type</th>
                  <th>Course</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requestsTableBody">
                <tr>
                  <td colspan="7" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Review Request Modal -->
  <div id="reviewModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2>Review Request</h2>
        <button class="modal-close" onclick="DACSystem.hideModal('reviewModal')">&times;</button>
      </div>
      
      <div id="reviewContent"></div>

      <form id="reviewForm">
        <input type="hidden" id="reviewRequestId" name="requestId">
        
        <div class="form-group">
          <label for="hodComments">Comments (Optional)</label>
          <textarea id="hodComments" name="comments" placeholder="Add any comments or feedback"></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="DACSystem.hideModal('reviewModal')">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="handleReview('rejected')">Reject</button>
          <button type="button" class="btn btn-success" onclick="handleReview('approved')">Approve</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="../script.js"></script>
  <script>
    if (!DACSystem.requireAuth() || DACSystem.getSession().role !== 'hod') {
      window.location.href = 'login.html';
    }

    const session = DACSystem.getSession();

    document.addEventListener('DOMContentLoaded', async () => {
      loadUserInfo();
      // Set department badge
      const dept = session.department || 'All';
      const el = document.getElementById('deptBadge');
      if (el) el.textContent = `Department: ${dept}`;
      await loadRequests();
      setupEventListeners();
      // Initialize sidebar toggle state
      const dash = document.querySelector('.dashboard');
      const btn = document.getElementById('toggleSidebar');
      if (dash && btn) {
        const updateAria = () => btn.setAttribute('aria-expanded', (!dash.classList.contains('collapsed')).toString());
        btn.addEventListener('click', () => { dash.classList.toggle('collapsed'); updateAria(); });
        updateAria();
      }
    });

    function loadUserInfo() {
      document.querySelector('.user-name').textContent = session.fullName;
      document.querySelector('.user-role').textContent = session.role.replace('_', ' ').toUpperCase();
      const deptEl = document.querySelector('.user-dept');
      if (deptEl) deptEl.textContent = session.department || '‚Äî';
    }

    async function loadRequests() {
      try {
        const filterStatus = document.getElementById('filterStatus').value;
        const allRequests = await DACSystem.getRequests('hod', session.id);
        
        let filteredRequests = allRequests;
        if (filterStatus !== 'all') {
          filteredRequests = allRequests.filter(r => {
            if (filterStatus === 'awaiting_hod') return r.status === 'awaiting_hod';
            if (filterStatus === 'approved') return r.hodApproval === 'approved';
            if (filterStatus === 'rejected') return r.hodApproval === 'rejected';
            return true;
          });
        }
        
        displayRequests(filteredRequests);
        updateStatistics(allRequests);
      } catch (error) {
        console.error('Error loading requests:', error);
        document.getElementById('requestsTableBody').innerHTML = 
          '<tr><td colspan="7" class="text-center">Error loading requests</td></tr>';
      }
    }

    function displayRequests(requests) {
      const tbody = document.getElementById('requestsTableBody');
      
      if (requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No requests found</td></tr>';
        return;
      }

      tbody.innerHTML = requests.map(req => `
        <tr>
          <td><strong>#${req.id}</strong></td>
          <td>${req.studentName}<br><small style="color: var(--light-text);">UID: ${req.universityId || '‚Äî'}</small></td>
          <td>${req.advisorName || 'N/A'}</td>
          <td><span class="badge badge-${req.type === 'add' ? 'success' : 'warning'}">${req.type.toUpperCase()}</span></td>
          <td>${req.courseCode || 'N/A'}<br><small>${req.courseName || ''}</small></td>
          <td>${DACSystem.getStatusBadge(req.status)}</td>
          <td>
            ${req.status === 'awaiting_hod' ? 
              `<div style="display:flex; gap:0.35rem; flex-wrap: wrap;">
                 <button class="btn btn-primary" onclick="reviewRequest('${req.id}')" style="padding: 0.4rem 1rem;">Review</button>
                 <button class="btn btn-success" onclick="quickHodDecision('${req.id}','approved')" style="padding: 0.4rem 0.9rem;">Approve</button>
                 <button class="btn btn-danger" onclick="quickHodDecision('${req.id}','rejected')" style="padding: 0.4rem 0.9rem;">Reject</button>
               </div>` :
              `<button class="btn btn-secondary" onclick="viewRequest('${req.id}')" style="padding: 0.4rem 1rem;">View</button>`
            }
          </td>
        </tr>
      `).join('');
    }

    function updateStatistics(requests) {
      document.getElementById('totalCount').textContent = requests.length;
      document.getElementById('awaitingCount').textContent = 
        requests.filter(r => r.status === 'awaiting_hod').length;
      document.getElementById('approvedCount').textContent = 
        requests.filter(r => r.hodApproval === 'approved').length;
      document.getElementById('rejectedCount').textContent = 
        requests.filter(r => r.hodApproval === 'rejected').length;
    }

    function setupEventListeners() {
      document.getElementById('filterStatus').addEventListener('change', loadRequests);
      document.getElementById('pendingBtn').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('filterStatus').value = 'awaiting_hod';
        loadRequests();
      });
      document.getElementById('sidebarLogout').addEventListener('click', (e) => {
        e.preventDefault();
        DACSystem.logout();
      });
      document.getElementById('logoutBtn').addEventListener('click', (e) => {
        e.preventDefault();
        DACSystem.logout();
      });
    }

    async function reviewRequest(requestId) {
      try {
        const requests = await DACSystem.getRequests('hod', session.id);
        const request = requests.find(r => r.id === requestId);
        
        if (!request) {
          DACSystem.showAlert('Request not found', 'danger');
          return;
        }

        displayReviewContent(request);
        document.getElementById('reviewRequestId').value = requestId;
        // Ensure modal footer and inputs are in review mode
        resetModalFooter();
        const commentsEl = document.getElementById('hodComments');
        if (commentsEl) commentsEl.disabled = false;
        DACSystem.showModal('reviewModal');
      } catch (error) {
        DACSystem.showAlert('Error loading request details', 'danger');
      }
    }

    function displayReviewContent(request) {
      const content = document.getElementById('reviewContent');
      
      content.innerHTML = `
        <div class="course-card">
          <h3>Student Information</h3>
          <div class="course-details">
            <div class="course-detail"><strong>Name:</strong> ${request.studentName}</div>
            <div class="course-detail"><strong>University ID:</strong> ${request.universityId || 'N/A'}</div>
            <div class="course-detail"><strong>Advisor:</strong> ${request.advisorName || 'N/A'}</div>
          </div>

          <h3 style="margin-top: 1.5rem;">Request Details</h3>
          <div class="course-details">
            <div class="course-detail"><strong>Request ID:</strong> #${request.id}</div>
            <div class="course-detail"><strong>Type:</strong> ${request.type.toUpperCase()}</div>
            <div class="course-detail"><strong>Course:</strong> ${request.courseCode} - ${request.courseName}</div>
          </div>

          <h3 style="margin-top: 1.5rem;">Approval History</h3>
          <div class="timeline">
            <div class="timeline-item completed">
              <div class="timeline-content">
                <strong>Advisor Approval</strong>
                <p>${request.advisorComments || 'No comments'}</p>
              </div>
            </div>
          </div>

          <h3 style="margin-top: 1.5rem;">Student's Reason</h3>
          <p style="background: var(--light-bg); padding: 1rem; border-radius: 8px;">${request.reason}</p>

          ${request.pdfUrl ? `<h3 style="margin-top: 1.5rem;">Approval Document</h3><a href="${request.pdfUrl}" target="_blank" class="btn btn-primary" style="display: inline-block;">üìÑ Download Approval PDF</a>` : ''}
        </div>
      `;
    }

    async function handleReview(decision) {
      const requestId = document.getElementById('reviewRequestId').value;
      const comments = document.getElementById('hodComments').value;

      if (!confirm(`Are you sure you want to ${decision} this request?`)) {
        return;
      }

      const footer = document.querySelector('#reviewModal .modal-footer');
      const buttons = footer ? footer.querySelectorAll('button') : [];
      const commentsField = document.getElementById('hodComments');

      try {
        // Prevent duplicate submissions
        buttons.forEach(btn => btn.disabled = true);
        if (commentsField) commentsField.disabled = true;

        const newStatus = decision === 'approved' ? 'awaiting_registrar' : 'rejected';
        console.log('HOD: Calling updateRequestStatus with status:', newStatus);
        await DACSystem.updateRequestStatus(requestId, newStatus, comments);
        console.log('HOD: API call completed, reloading page...');
        
        // Force page reload
        window.location.reload(true);
      } catch (error) {
        console.error('handleReview error:', error);
        DACSystem.showAlert(error.message || 'Failed to update request', 'danger');
        // Re-enable controls on error
        buttons.forEach(btn => btn.disabled = false);
        if (commentsField) commentsField.disabled = false;
      }
    }

    async function quickHodDecision(requestId, decision) {
      const newStatus = decision === 'approved' ? 'awaiting_registrar' : 'rejected';
      const confirmMsg = decision === 'approved'
        ? 'Approve and forward to Registrar?'
        : 'Reject this request and notify student/advisor?';

      if (!confirm(confirmMsg)) return;

      try {
        await DACSystem.updateRequestStatus(requestId, newStatus, '');
        DACSystem.hideModal('reviewModal');
        DACSystem.showAlert(
          decision === 'approved' ? 'Approved and sent to Registrar.' : 'Request rejected.',
          decision === 'approved' ? 'success' : 'warning'
        );
        setTimeout(() => location.reload(), 500);
      } catch (error) {
        console.error('quickHodDecision error', error);
        DACSystem.showAlert(error.message || 'Failed to update request', 'danger');
      }
    }

    async function viewRequest(requestId) {
      const requests = await DACSystem.getRequests('hod', session.id);
      const request = requests.find(r => r.id === requestId);
      
      if (request) {
        displayReviewContent(request);
        document.querySelector('#reviewModal .modal-footer').innerHTML = `
          <button type="button" class="btn btn-secondary" onclick="DACSystem.hideModal('reviewModal'); resetModalFooter();">Close</button>
        `;
        document.getElementById('hodComments').disabled = true;
        DACSystem.showModal('reviewModal');
      }
    }

    function resetModalFooter() {
      document.querySelector('#reviewModal .modal-footer').innerHTML = `
        <button type="button" class="btn btn-secondary" onclick="DACSystem.hideModal('reviewModal')">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="handleReview('rejected')">Reject</button>
        <button type="button" class="btn btn-success" onclick="handleReview('approved')">Approve</button>
      `;
      document.getElementById('hodComments').disabled = false;
    }
  </script>
</body>
</html>
